{% extends 'base.html' %}
{% block title %}{{ community.name }} | MicroBlogHub{% endblock %}

{% block content %}
<section class="container full-width community-detail">
  <h1>{{ community.name }}</h1>
  {% if request.user.is_authenticated and community.created_by and request.user == community.created_by %}
    <div style="margin-top:0.5rem;">
      <a href="{% url 'delete_community' community.id %}" class="icon-btn" title="Delete community">ğŸ—‘ï¸ Delete community</a>
    </div>
  {% endif %}
  <p class="communuty-desc">{{ community.description }}</p>

  <section class="community-composer composer-card">
    {% if request.user.is_authenticated %}
      <div class="avatar">{{ request.user.username|first|upper }}</div>
      <form method="POST" action="" class="composer-main">
        {% csrf_token %}
        <textarea name="content" rows="3" maxlength="1000" placeholder="Post to {{ community.name }}"></textarea>
        <input type="hidden" name="action" value="post">
        <div class="composer-footer">
          <span></span>
          <div class="composer-actions">
            <button type="submit" class="primary-btn">Post</button>
          </div>
        </div>
      </form>
    {% else %}
      <p><a href="{% url 'login' %}">Log in</a> to post in this community.</p>
    {% endif %}
  </section>

  <section class="community-posts">
    {% for post in posts %}
      <article class="post">
        <div class="avatar">{{ post.user.username|first|upper }}</div>
        <div class="post-main">
          <header class="post-header" style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
            <div>
              <strong>{{ post.user.username }}</strong>
              <span class="post-dot">Â·</span>
              <span class="post-time">{{ post.created_at|timesince }} ago</span>
            </div>
            <div class="post-owner-actions">
              {% if request.user.is_authenticated and request.user == post.user %}
                <a href="{% url 'edit_community_post' community.id post.id %}" class="action-btn" title="Edit">âœï¸</a>
                <form method="POST" action="{% url 'delete_community_post' community.id post.id %}" style="display:inline;" onsubmit="return confirm('Delete this post?');">
                  {% csrf_token %}
                  <button type="submit" class="icon-btn" title="Delete post">ğŸ—‘ï¸</button>
                </form>
              {% elif request.user.is_authenticated and request.user == community.created_by %}
                <form method="POST" action="{% url 'delete_community_post' community.id post.id %}" style="display:inline;" onsubmit="return confirm('Delete this post?');">
                  {% csrf_token %}
                  <button type="submit" class="icon-btn" title="Delete post">ğŸ—‘ï¸</button>
                </form>
              {% endif %}
            </div>
          </header>
          <div class="post-body">{{ post.content }}</div>

          <div class="post-comments">
            <h4>Comments ({{ post.comments.count }})</h4>
            <div class="comments-list">
              {% for c in post.comments.all %}
                <div class="comment-item" style="display:flex; gap:0.5rem; align-items:flex-start;">
                  <div class="comment-avatar avatar">{{ c.user.username|first|upper }}</div>
                  <div class="comment-content" style="flex:1;">
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                      <strong>{{ c.user.username }}</strong>
                      <span class="comment-time">Â· {{ c.created_at|timesince }} ago</span>
                      {% if request.user.is_authenticated %}
                        {% if request.user == c.user or request.user == community.created_by %}
                          <form method="POST" action="{% url 'delete_community_comment' community.id c.id %}" style="display:inline; margin-left:0.5rem;" onsubmit="return confirm('Delete this comment?');">
                            {% csrf_token %}
                            <button type="submit" class="icon-btn" title="Delete comment">ğŸ—‘ï¸</button>
                          </form>
                        {% endif %}
                      {% endif %}
                    </div>
                    <div class="comment-text">{{ c.text }}</div>
                  </div>
                </div>
              {% empty %}
                <p>No comments yet.</p>
              {% endfor %}
            </div>

            {% if request.user.is_authenticated %}
              <form method="POST" action="" style="margin-top:0.5rem;">
                {% csrf_token %}
                <input type="hidden" name="action" value="comment">
                <input type="hidden" name="post_id" value="{{ post.id }}">
                <div style="display:flex; gap:0.5rem;">
                  <input type="text" name="comment" placeholder="Write a comment..." required class="text-input">
                  <button type="submit" class="primary-btn">Reply</button>
                </div>
              </form>
            {% else %}
              <p><a href="{% url 'login' %}">Log in</a> to comment.</p>
            {% endif %}
          </div>
        </div>
      </article>
    {% empty %}
      <p>No posts yet in this community.</p>
    {% endfor %}
  </section>
</section>

{% endblock %}

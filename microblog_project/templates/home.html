{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MicroBlogHub{% endblock %}

{% block content %}

<script src="{% static 'js/vibetext.js' %}"></script>

<!-- Messages Display -->
{% if messages %}
<div class="messages-container">
  {% for message in messages %}
  <div class="message-alert {% if message.tags %}{{ message.tags }}{% endif %}">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="app-shell">
{% include 'partials/sidebar.html' %}
  
<!-- ================= MAIN CONTENT ================= -->
<main class="main">

    <!-- COMPOSER -->
    {% if request.user.is_authenticated %}
    <section class="composer-card">
      {% if profile and profile.photo %}
        <div class="avatar"><img src="{{ profile.photo.url }}{% if profile.photo.name %}?v={{ profile.photo.name }}{% endif %}" alt="{{ request.user.username }}'s avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" /></div>
      {% else %}
        <div class="avatar">{{ request.user.username|first|upper }}</div>
      {% endif %}

    <form method="POST" action="{% url 'create_post' %}" class="composer-main">
      {% csrf_token %}
      <textarea name="content" rows="3"
        placeholder="What's happening?" required></textarea>
      <div class="composer-footer">
        <div class="composer-actions">
            <button type="submit" name="action" value="publish" class="primary-btn">Post</button>
            <!-- save draft (submit) -->
            <button type="submit" name="action" value="draft" class="icon-btn" title="Save draft" aria-label="Save draft">
              <!-- pencil icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#e5e7eb"/></svg>
            </button>
            <!-- drafts link merged into icon (folder glyph to differentiate) -->
            <a href="{% url 'drafts' %}" class="icon-btn" title="Drafts" aria-label="Drafts">
              <!-- folder icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 4H2v16h20V6H12l-2-2z" fill="#e5e7eb"/></svg>
            </a>
          </div>
      </div>
    </form>
  </section>
  {% else %}
  <section class="composer-card guest">
    <div style="padding:1rem">
      <p><strong>Welcome!</strong> <a href="{% url 'login' %}">Log in</a> or <a href="{% url 'register' %}">create an account</a> to post and interact.</p>
    </div>
  </section>
  {% endif %}

    <!-- ================= POSTS ================= -->
  <section class="posts-list">
    {% for post in posts %}
    <article class="post">

        <div class="avatar">
          {% with up=post.user.profile %}
            {% if up and up.photo %}
              <img src="{{ up.photo.url }}{% if up.photo.name %}?v={{ up.photo.name }}{% endif %}" alt="{{ post.user.username }}'s avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
            {% else %}
              {{ post.user.username|first|upper }}
            {% endif %}
          {% endwith %}
        </div>
      </a>

      <div class="post-main">
        <header class="post-header">
          <a href="{% url 'profile' post.user.username %}" class="post-author-link">
            @{{ post.user.username }}
          </a>
          <span class="post-dot">¬∑</span>
          <span class="post-time">{{ post.created_at }} ago</span>
        </header>

          <p class="post-body">{{ post.content|urlize|linebreaksbr }}</p>
          <footer class="post-footer">
            <div class="post-actions">
              <div class="like-section">
                  {% if post.is_community %}
                    <span class="action-btn">
                      <span class="action-icon">ü§ç</span>
                      <span class="action-count">{{ post.like_count }}</span>
                    </span>
                  {% else %}
                    {% if post.id in liked_posts %}
                      <a href="{% url 'unlike' post.id %}" class="action-btn liked">
                        <span class="action-icon">‚ù§Ô∏è</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% else %}
                      <a href="{% url 'like' post.id %}" class="action-btn">
                        <span class="action-icon">ü§ç</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% endif %}
                  {% endif %}
              </div>
              {% if request.user.is_authenticated and request.user == post.user %}
                <div class="post-owner-actions">
                  <a href="{% url 'edit_post' post.id %}" class="action-btn" title="Edit">‚úèÔ∏è</a>
                  <button type="button" class="action-btn delete-btn" data-delete-url="{% url 'delete_post' post.id %}" data-post-content="{{ post.content|escapejs }}" title="Delete">üóëÔ∏è</button>
                </div>
              {% endif %}
              
            </div>
          </footer>

               <!-- Comments -->
       <section class="comments-section">

        {% for comment in post.comment_set.all %}
          {% if not comment.parent %}
          <div class="yt-comment">
        
            <!-- Avatar -->
            
            <!-- Comment Body -->
            <div class="yt-body">
        
              <div class="yt-header">
                <span class="yt-username">@{{ comment.user.username }}</span>
                <span class="yt-time">{{ comment.created_at}} ago</span>
              </div>
        
              <div class="yt-text" id="comment-text-{{ comment.id }}">
                {{ comment.text }}
              </div>
        
              <!-- Actions -->
               <div class="yt-actions">
                <button onclick="toggleReply('{{ comment.id }}')">Reply</button>

                <a href="{% url 'toggle_comment_like' comment.id %}" class="comment-like-btn">
                  {% if comment.id in liked_comments %}
                      ‚ù§Ô∏è {{ comment.likes.count }}
                    {% else %}
                    ü§ç {{ comment.likes.count }}
                    {% endif %}
                </a>

                  {% if user == comment.user %}
                    <button onclick="toggleEdit('{{ comment.id }}')">Edit</button>
                    <a href="{% url 'delete_comment' comment.id %}" class="danger">Delete</a>
                  {% endif %}
                 </div>

              <!-- Edit form -->
              {% if user == comment.user %}
              <form method="POST"
                    action="{% url 'edit_comment' comment.id %}"
                    id="edit-form-{{ comment.id }}"
                    class="yt-edit-form"
                    style="display:none;">
                {% csrf_token %}
                <input type="text" name="text" value="{{ comment.text }}">
                <button type="submit">Save</button>
              </form>
              {% endif %}
        
              <!-- Reply form -->
              <form method="POST"
                    action="{% url 'reply_comment' comment.id %}"
                    id="reply-form-{{ comment.id }}"
                    class="yt-reply-form"
                    style="display:none;">
                {% csrf_token %}
                <input type="text" name="text" placeholder="Add a reply‚Ä¶">
                <button type="submit">Reply</button>
              </form>
        
              <!-- Replies toggle -->
              {% if comment.replies.count %}
              <button type="button"
              class="yt-view-replies"
              id="toggle-btn-{{ comment.id }}"
              data-count="{{ comment.replies.count }}"
              onclick="toggleReplies('{{ comment.id }}')">
              View {{ comment.replies.count }} replies ‚ñº
              </button>
      
      
              {% endif %}
        
              <!-- Replies -->
              <div class="yt-replies" id="replies-{{ comment.id }}" style="display:none;">
                {% for reply in comment.replies.all %}
                <div class="yt-reply">
        
                  <div class="yt-avatar small">
                    {{ reply.user.username|first|upper }}
                  </div>
        
                  <div class="yt-body">
                    <span class="yt-username">@{{ reply.user.username }}</span>
                    <p>{{ reply.text }}</p>
                  </div>
        
                </div>
                {% endfor %}
              </div>
        
            </div>
          </div>
          {% endif %}
        {% endfor %}
        
        <!-- New Comment -->
        <form method="POST" action="{% url 'add_comment' post.id %}" class="yt-new-comment">
          {% csrf_token %}
          <input type="text" name="comment" placeholder="Add a comment‚Ä¶" required>
          <button type="submit">Send</button>
        </form>
        
        </section>
        


      </div>
    </article>
    {% empty %}
     <p>No posts yet.</p>
    {% endfor %}
  </section>

</main>

<aside class="right-sidebar">
  <section class="trending-section">
    <h3>Trending</h3>
    <div class="hashtag-list">
      {% for tag in trending_hashtags %}
        <a href="{% url 'search' %}?q=%23{{ tag }}" class="hashtag-chip">#{{ tag }}</a>
      {% empty %}
        <p>No trending tags yet</p>
      {% endfor %}
    </div>

    <h4>Top posts</h4>
    <div class="trending-posts">
      {% for tpost in trending_posts %}
        <div class="tpost-row">
          <div class="avatar">{{ tpost.user.username|first|upper }}</div>
          <div class="tpost-main">
            <a href="{% url 'profile' tpost.user.username %}"><strong>{{ tpost.user.username }}</strong></a>
            <a href="{% url 'post_detail' tpost.id %}" class="tpost-link"><p class="tpost-snippet">{{ tpost.content|truncatechars:60 }}</p></a>
          </div>
        </div>
      {% empty %}
        <p>No trending posts yet</p>
      {% endfor %}
    </div>
  </section>
</aside>

</div>


<script>
  function toggleReply(id) {
      const f = document.getElementById(`reply-form-${id}`);
      f.style.display = f.style.display === "block" ? "none" : "block";
  }
  
  function toggleEdit(id) {
      document.getElementById(`edit-form-${id}`).style.display = "block";
      document.getElementById(`comment-text-${id}`).style.display = "none";
  }
  
  function toggleReplies(id) {
      const replies = document.getElementById(`replies-${id}`);
      const btn = document.getElementById(`toggle-btn-${id}`);
  
      if (!replies || !btn) return;
  
      const count = btn.getAttribute("data-count");
  
      if (replies.style.display === "none" || replies.style.display === "") {
          replies.style.display = "block";
          btn.innerText = "Hide replies ‚ñ≤";
      } else {
          replies.style.display = "none";
          btn.innerText = `View ${count} replies ‚ñº`;
      }
  }
  </script>
  

{% endblock %}





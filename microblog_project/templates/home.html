{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MicroBlogHub{% endblock %}

{% block content %}

<script src="{% static 'js/vibetext.js' %}"></script>

<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <div class="brand">
      <div class="brand-text">
        <h1>vibetext E3</h1>
        <p>Express ‚Ä¢ Engage ‚Ä¢ Echo</p>
      </div>
    </div>

    

    <section class="current-user-card">
      <div class="avatar avatar-lg">
        {{ request.user.username|first|upper }}
      </div>
      <div class="user-meta">
        <h2>@{{ request.user.username }}</h2>
        <p>Logged in user</p>
      </div>

      <!-- ‚úÖ PROFILE LINK (CORRECT) -->
      <a href="{% url 'profile' request.user.username %}">
        View Profile
      </a>
    </section>

    <section class="people-section">
      <h3>People</h3>

      {% for u in users %}
      <div class="person-row">
        <div class="avatar">{{ u.username|first|upper }}</div>
        <div class="person-main">
          <strong>{{ u.username }}</strong>
        </div>

        {% if u.id in following_ids %}
          <a href="{% url 'unfollow' u.id %}" class="follow-chip">Unfollow</a>
        {% else %}
          <a href="{% url 'follow' u.id %}" class="follow-chip">Follow</a>
        {% endif %}
      </div>
      {% endfor %}
    </section>

  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- COMPOSER -->
    <section class="composer-card">
      <div class="avatar">{{ request.user.username|first|upper }}</div>

      <form method="POST" action="{% url 'create_post' %}" class="composer-main">
        {% csrf_token %}
        <textarea name="content" maxlength="280" rows="2"
          placeholder="What's happening?" required></textarea>

        <div class="composer-footer">
          <span id="charCount">0 / 280</span>
          <button type="submit" class="primary-btn">Post</button>
        </div>
      </form>
    </section>

    <!-- POSTS -->
    <section class="posts-list">
      {% for post in posts %}
      <article class="post">

        <div class="avatar">
          {{ post.user.username|first|upper }}
        </div>

        <div class="post-main">

          <header class="post-header">
            <div>
              <!-- ‚úÖ PROFILE LINK PER POST -->
              <a href="{% url 'profile' post.user.username %}">
                <span class="post-author-name">{{ post.user.username }}</span>
              </a>
              <span class="post-dot">¬∑</span>
              <span class="post-time">{{ post.created_at|timesince }} ago</span>
            </div>
          </header>

          <p class="post-body">{{ post.content }}</p>

          <footer class="post-footer">
            <div class="post-actions">
              <div class="like-section">
                {% if post.id in liked_posts %}
                  <a href="{% url 'unlike' post.id %}" class="action-btn liked">
                    <span class="action-icon">‚ù§Ô∏è</span>
                    <span class="action-count">{{ post.like_set.count }}</span>
                  </a>
                {% else %}
                  <a href="{% url 'like' post.id %}" class="action-btn">
                    <span class="action-icon">ü§ç</span>
                    <span class="action-count">{{ post.like_set.count }}</span>
                  </a>
                {% endif %}
              </div>
              <div class="comment-toggle">
                <button type="button" class="action-btn comment-btn" onclick="toggleComments(this)" aria-label="Toggle comments">
                  <span class="action-icon">üí¨</span>
                  <span class="action-count">{{ post.comment_set.count }}</span>
                  {% if post.comment_set.count > 0 %}
                    <span class="comment-badge">{{ post.comment_set.count }}</span>
                  {% endif %}
                </button>
              </div>
            </div>
          </footer>

          <!-- COMMENTS -->
          <section class="comments" style="display: none;" aria-label="Comments section">
            <div class="comments-header">
              <h4>
                <span class="comments-icon">üí¨</span>
                Comments
                {% if post.comment_set.count > 0 %}
                  <span class="comments-count">({{ post.comment_set.count }})</span>
                {% endif %}
              </h4>
            </div>
            <div class="comments-list">
              {% for comment in post.comment_set.all %}
                <div class="comment-item">
                  <div class="comment-avatar">{{ comment.user.username|first|upper }}</div>
                  <div class="comment-content">
                    <div class="comment-author">
                      <a href="{% url 'profile' comment.user.username %}">
                        <strong>{{ comment.user.username }}</strong>
                      </a>
                      <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                    </div>
                    <div class="comment-text">{{ comment.text }}</div>
                  </div>
                </div>
              {% empty %}
                <p class="no-comments">
                  <span class="no-comments-icon">üí≠</span>
                  No comments yet. Be the first to comment!
                </p>
              {% endfor %}
            </div>
            <form method="POST" action="{% url 'add_comment' post.id %}" class="comment-form">
              {% csrf_token %}
              <div class="comment-input-wrapper">
                <input type="text" name="comment" placeholder="Write a comment..." required aria-label="Comment input">
                <button type="submit" class="comment-submit-btn" aria-label="Submit comment">
                  <span>Post</span>
                  <span class="submit-icon">‚Üí</span>
                </button>
              </div>
            </form>
          </section>

        </div>
      </article>
      {% endfor %}
    </section>

  </main>
</div>

{% endblock %}

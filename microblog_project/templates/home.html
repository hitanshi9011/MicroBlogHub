{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MicroBlogHub{% endblock %}

{% block content %}

<script src="{% static 'js/vibetext.js' %}"></script>

<!-- Messages Display -->
{% if messages %}
  <div class="messages-container">
    {% for message in messages %}
      <div class="message-alert {% if message.tags %}{{ message.tags }}{% endif %}">
        <span class="message-icon">
          {% if message.tags == 'success' %}‚úì{% elif message.tags == 'error' %}‚úï{% else %}‚Ñπ{% endif %}
        </span>
        <span>{{ message }}</span>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <div class="brand">
      <div class="brand-text">
        <h1>vibetext E3</h1>
        <p>Express ‚Ä¢ Engage ‚Ä¢ Echo</p>
      </div>
    </div>

    

    <section class="current-user-card">
      <div class="avatar avatar-lg">
        {{ request.user.username|first|upper }}
      </div>
      <div class="user-meta">
        <h2>@{{ request.user.username }}</h2>
        <p>Logged in user</p>
      </div>

      <!-- ‚úÖ PROFILE LINK (CORRECT) -->
      <a href="{% url 'profile' request.user.username %}">
        View Profile
      </a>
    </section>

    <section class="people-section">
      <h3>People</h3>
    
      {% for u in users %}
      <div class="person-row">
    
        <!-- Avatar ‚Üí Profile -->
        <a href="{% url 'profile' u.username %}" class="avatar-link">
          <div class="avatar">{{ u.username|first|upper }}</div>
        </a>
    
        <!-- Username ‚Üí Profile -->
        <div class="person-main">
          <a href="{% url 'profile' u.username %}" class="person-name-link">
            <strong>{{ u.username }}</strong>
          </a>
        </div>
    
        <!-- Actions -->
        <div class="person-actions">
          <a href="{% url 'conversation' u.username %}" class="message-chip" title="Message {{ u.username }}">
            <span>üí¨</span>
          </a>
          {% if u.id in following_ids %}
            <a href="{% url 'unfollow' u.id %}" class="follow-chip">Unfollow</a>
          {% else %}
            <a href="{% url 'follow' u.id %}" class="follow-chip">Follow</a>
          {% endif %}
        </div>
    
      </div>
      {% endfor %}
    </section>
    

  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- COMPOSER -->
    <section class="composer-card">
      <div class="avatar">{{ request.user.username|first|upper }}</div>

      <form method="POST" action="{% url 'create_post' %}" class="composer-main">
        {% csrf_token %}
        <textarea name="content" rows="3"
          placeholder="What's happening?" required></textarea>

        <div class="composer-footer">
          <button type="submit" class="primary-btn">Post</button>
        </div>
      </form>
    </section>

    <!-- POSTS -->
    <section class="posts-list">
      {% for post in posts %}
      <article class="post">

        <!-- Clickable Avatar to Profile -->
        <a href="{% url 'profile' post.user.username %}" class="post-avatar-link" title="View {{ post.user.username }}'s profile">
          <div class="avatar post-avatar">
            {{ post.user.username|first|upper }}
          </div>
        </a>

        <div class="post-main">

          <header class="post-header">
            <div>
              <!-- Clickable Username to Profile -->
              <a href="{% url 'profile' post.user.username %}" class="post-author-link" title="View {{ post.user.username }}'s profile">
                <span class="post-author-name">@{{ post.user.username }}</span>
              </a>
              <span class="post-dot">¬∑</span>
              <span class="post-time">{{ post.created_at|timesince }} ago</span>
            </div>
          </header>

          <p class="post-body">{{ post.content }}</p>

          <div class="like-section">
            {% if user.is_authenticated %}
              {% if post.id in liked_posts %}
                <a
                  href="{% url 'unlike' post.id %}"
                  class="action-btn liked-btn"
                  data-post-id="{{ post.id }}"
                  data-action="unlike"
                  aria-pressed="true"
                  title="Unlike"
                >
                  <span class="action-icon liked-icon">‚ù§Ô∏è</span>
                  <span class="action-count">{{ post.like_set.count }}</span>
                </a>
              {% else %}
                <a
                  href="{% url 'like' post.id %}"
                  class="action-btn like-btn"
                  data-post-id="{{ post.id }}"
                  data-action="like"
                  aria-pressed="false"
                  title="Like"
                >
                  <span class="action-icon">ü§ç</span>
                  <span class="action-count">{{ post.like_set.count }}</span>
                </a>
              {% endif %}
            {% else %}
              <div
                class="action-btn like-btn-disabled"
                title="Login to like"
                aria-disabled="true"
              >
                <span class="action-icon">ü§ç</span>
                <span class="action-count">{{ post.like_set.count }}</span>
              </div>
            {% endif %}
          </div>

          <form method="POST" action="{% url 'create_post' %}">
            {% csrf_token %}
            <textarea name="content" rows="3" placeholder="What's happening?" required></textarea>
            <button type="submit" class="primary-btn">Post</button>
          </form>
          
          

          <!-- COMMENTS SECTION - Simple and Clean -->
          <section class="comments-section" aria-label="Comments section">
            <!-- Comments List - All visible by default -->
            {% if post.comment_set.count > 0 %}
              <div class="comments-list-container" id="comments-{{ post.id }}">
                <div class="comments-header-simple">
                  <span class="comments-count-badge">{{ post.comment_set.count }}</span>
                  <span class="comments-label">Comment{{ post.comment_set.count|pluralize }}</span>
                </div>
                <div class="comments-list">
                  {% for comment in post.comment_set.all %}
                    <div class="comment-item" data-comment-id="{{ comment.id }}">
                      <div class="comment-avatar">{{ comment.user.username|first|upper }}</div>
                      <div class="comment-content">
                        <div class="comment-author">
                          <a href="{% url 'profile' comment.user.username %}" class="comment-author-link">
                            <strong>{{ comment.user.username }}</strong>
                          </a>
                          <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                        </div>
                        <div class="comment-text">{{ comment.text }}</div>
                      </div>
                      {% if user.is_authenticated and user == comment.user %}
                        <a href="{% url 'delete_comment' comment.id %}" class="comment-delete-btn" onclick="return confirmDeleteComment(event)" title="Delete comment">
                          <span class="delete-icon">üóëÔ∏è</span>
                        </a>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <!-- Comment Form - Always Visible -->
            <div class="comment-form-container">
              <form method="POST" action="{% url 'add_comment' post.id %}" class="comment-form">
                {% csrf_token %}
                <div class="comment-input-wrapper">
                  <div class="comment-input-avatar">{{ request.user.username|first|upper }}</div>
                  <input type="text" name="comment" placeholder="Write a comment..." required aria-label="Comment input" class="comment-input">
                  <button type="submit" class="comment-submit-btn" aria-label="Submit comment">
                    <span>‚ñ∂ Send</span>
                  </button>
                </div>
              </form>
            </div>
          </section>

        </div>
      </article>
      {% endfor %}
    </section>

  </main>
</div>

{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MicroBlogHub{% endblock %}

{% block content %}

<script src="{% static 'js/vibetext.js' %}"></script>

<div class="app-shell">

  <!-- SIDEBAR -->
  {% include 'partials/sidebar.html' %}

  <!-- MAIN -->
  <main class="main">

    <!-- COMPOSER -->
    {% if request.user.is_authenticated %}
    <section class="composer-card">
      <div class="avatar">{{ request.user.username|first|upper }}</div>

      <form method="POST" action="{% url 'create_post' %}" class="composer-main">
        {% csrf_token %}
        <textarea name="content" maxlength="280" rows="2"
          placeholder="What's happening?" required></textarea>

        <div class="composer-footer">
          <span id="charCount">0 / 280</span>
          <div class="composer-actions">
            <button type="submit" name="action" value="publish" class="primary-btn">Post</button>
            <!-- save draft (submit) -->
            <button type="submit" name="action" value="draft" class="icon-btn" title="Save draft" aria-label="Save draft">
              <!-- pencil icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#e5e7eb"/></svg>
            </button>
            <!-- drafts link merged into icon (folder glyph to differentiate) -->
            <a href="{% url 'drafts' %}" class="icon-btn" title="Drafts" aria-label="Drafts">
              <!-- folder icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 4H2v16h20V6H12l-2-2z" fill="#e5e7eb"/></svg>
            </a>
          </div>
        </div>
      </form>
    </section>
    {% else %}
    <section class="composer-card guest">
      <div style="padding:1rem">
        <p><strong>Welcome!</strong> <a href="{% url 'login' %}">Log in</a> or <a href="{% url 'register' %}">create an account</a> to post and interact.</p>
      </div>
    </section>
    {% endif %}

    <!-- POSTS -->
    <section class="posts-list">
      {% for post in posts %}
      <article class="post">

        <div class="avatar">
          {{ post.user.username|first|upper }}
        </div>

        <div class="post-main">

          <header class="post-header">
            <div>
              <!-- ‚úÖ PROFILE LINK PER POST -->
              <a href="{% url 'profile' post.user.username %}">
                <span class="post-author-name">{{ post.user.username }}</span>
              </a>
              <span class="post-dot">¬∑</span>
              <span class="post-time">{{ post.created_at|timesince }} ago</span>
            </div>
          </header>

          <p class="post-body">{{ post.content }}</p>

          <footer class="post-footer">
            <div class="post-actions">
              <div class="like-section">
                  {% if post.is_community %}
                    <span class="action-btn">
                      <span class="action-icon">ü§ç</span>
                      <span class="action-count">{{ post.like_count }}</span>
                    </span>
                  {% else %}
                    {% if post.id in liked_posts %}
                      <a href="{% url 'unlike' post.id %}" class="action-btn liked">
                        <span class="action-icon">‚ù§Ô∏è</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% else %}
                      <a href="{% url 'like' post.id %}" class="action-btn">
                        <span class="action-icon">ü§ç</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% endif %}
                  {% endif %}
              </div>
              <div class="comment-toggle">
                <button type="button" class="action-btn comment-btn" onclick="toggleComments(this)" aria-label="Toggle comments">
                  <span class="action-icon">üí¨</span>
                  <span class="action-count">{{ post.comment_count }}</span>
                  {% if post.comment_count > 0 %}
                    <span class="comment-badge">{{ post.comment_count }}</span>
                  {% endif %}
                </button>
              </div>

              {% if request.user.is_authenticated and request.user == post.user %}
                <div class="post-owner-actions">
                  <a href="{% url 'edit_post' post.id %}" class="action-btn" title="Edit">‚úèÔ∏è</a>
                  <button type="button" class="action-btn delete-btn" data-delete-url="{% url 'delete_post' post.id %}" data-post-content="{{ post.content|escapejs }}" title="Delete">üóëÔ∏è</button>
                </div>
              {% endif %}
              

            </div>
          </footer>

          <!-- COMMENTS -->
          <section class="comments" style="display: none;" aria-label="Comments section">
            <div class="comments-header">
              <h4>
                <span class="comments-icon">üí¨</span>
                Comments
                {% if post.comment_set.count > 0 %}
                  <span class="comments-count">({{ post.comment_set.count }})</span>
                {% endif %}
              </h4>
            </div>
            <div class="comments-list">
              {% for comment in post.comment_set.all %}
                <div class="comment-item">
                  <div class="comment-avatar">{{ comment.user.username|first|upper }}</div>
                  <div class="comment-content">
                    <div class="comment-author">
                      <a href="{% url 'profile' comment.user.username %}">
                        <strong>{{ comment.user.username }}</strong>
                      </a>
                      <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                    </div>
                    <div class="comment-text">{{ comment.text }}</div>
                  </div>
                </div>
              {% empty %}
                <p class="no-comments">
                  <span class="no-comments-icon">üí≠</span>
                  No comments yet. Be the first to comment!
                </p>
              {% endfor %}
            </div>
            <form method="POST" action="{% url 'add_comment' post.id %}" class="comment-form">
              {% csrf_token %}
              <div class="comment-input-wrapper">
                <input type="text" name="comment" placeholder="Write a comment..." required aria-label="Comment input">
                <button type="submit" class="comment-submit-btn" aria-label="Submit comment">
                  <span>Post</span>
                  <span class="submit-icon">‚Üí</span>
                </button>
              </div>
            </form>
          </section>

        </div>
      </article>
      {% endfor %}
    </section>

  </main>

  <aside class="right-sidebar">
    <section class="trending-section">
      <h3>Trending</h3>
      <div class="hashtag-list">
        {% for tag in trending_hashtags %}
          <a href="{% url 'search' %}?q=%23{{ tag }}" class="hashtag-chip">#{{ tag }}</a>
        {% empty %}
          <p>No trending tags yet</p>
        {% endfor %}
      </div>

      <h4>Top posts</h4>
      <div class="trending-posts">
        {% for tpost in trending_posts %}
          <div class="tpost-row">
            <div class="avatar">{{ tpost.user.username|first|upper }}</div>
            <div class="tpost-main">
              <a href="{% url 'profile' tpost.user.username %}"><strong>{{ tpost.user.username }}</strong></a>
              <a href="{% url 'post_detail' tpost.id %}" class="tpost-link"><p class="tpost-snippet">{{ tpost.content|truncatechars:60 }}</p></a>
            </div>
          </div>
        {% empty %}
          <p>No trending posts yet</p>
        {% endfor %}
      </div>
    </section>
  </aside>
</div>

{% endblock %}

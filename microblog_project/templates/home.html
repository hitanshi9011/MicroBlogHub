{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MicroBlogHub{% endblock %}

{% block content %}

<script src="{% static 'js/vibetext.js' %}"></script>

<!-- Messages Display -->
{% if messages %}
<div class="messages-container">
  {% for message in messages %}
  <div class="message-alert {% if message.tags %}{{ message.tags }}{% endif %}">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="app-shell">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">

  <div class="brand">
  </div>

  <!-- Notifications -->
  

  <div id="notificationPopup" class="notification-popup" style="display:none;">
    <div class="notification-header">
      <h3>Notifications</h3>
      <button class="close-btn" onclick="closeNotificationPopup()">√ó</button>
    </div>
    <div class="notification-body">
      {% if unread_notifications and unread_notifications.count %}
      <ul class="notification-list">
        {% for n in unread_notifications %}
        <li class="notification-item">
          <p>{{ n.message }}</p>
          <small>{{ n.created_at|timesince }} ago</small>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="no-notifications">No new notifications</p>
      {% endif %}
    </div>
  </div>

  <!-- Current User -->
  <section class="current-user-card">
    <div class="avatar avatar-lg">
      {{ request.user.username|first|upper }}
    </div>
    <div class="user-meta">
      <h2>@{{ request.user.username }}</h2>
      <p>Logged in user</p>
    </div>
    <a href="{% url 'profile' request.user.username %}">View Profile</a>
  </section>

  <!-- ================= PEOPLE SECTION ================= -->
  <section class="people-section">
    <h3>People</h3>

    {% if users %}
      {% for u in users %}
      <div class="person-row">

        <!-- Avatar -->
        <a href="{% url 'profile' u.username %}" class="avatar-link">
          <div class="avatar">{{ u.username|first|upper }}</div>
        </a>
        

        <!-- Username -->
        <div class="person-main">
          <a href="{% url 'profile' u.username %}">@{{ u.username }}</a>
          {% if u.profile and u.profile.bio %}
            <p class="person-bio">{{ u.profile.bio|truncatechars:60 }}</p>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="person-actions">
          <a href="{% url 'conversation' u.username %}" class="message-chip" title="Message">‚úâÔ∏è</a>

          {% if following_ids and u.id in following_ids %}
            <a href="{% url 'unfollow' u.id %}" class="follow-chip">Unfollow</a>
          {% else %}
            <a href="{% url 'follow' u.id %}" class="follow-chip">Follow</a>
          {% endif %}
        </div>

      </div>
      {% endfor %}
    {% else %}
      <p class="no-people-msg">No people to suggest right now.</p>
    {% endif %}
  </section>

</aside>
  <!-- SIDEBAR -->
  {% include 'partials/sidebar.html' %}

<!-- ================= MAIN CONTENT ================= -->
<main class="main">

    <!-- COMPOSER -->
    {% if request.user.is_authenticated %}
    <section class="composer-card">
      <div class="avatar">{{ request.user.username|first|upper }}</div>

    <form method="POST" action="{% url 'create_post' %}" class="composer-main">
      {% csrf_token %}
      <textarea name="content" rows="3"
        placeholder="What's happening?" required></textarea>
      <div class="composer-footer">
        <button type="submit" class="primary-btn">Post</button>
      </div>
    </form>
  </section>

        <div class="composer-footer">
          <span id="charCount">0 / 280</span>
          <div class="composer-actions">
            <button type="submit" name="action" value="publish" class="primary-btn">Post</button>
            <!-- save draft (submit) -->
            <button type="submit" name="action" value="draft" class="icon-btn" title="Save draft" aria-label="Save draft">
              <!-- pencil icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="#e5e7eb"/></svg>
            </button>
            <!-- drafts link merged into icon (folder glyph to differentiate) -->
            <a href="{% url 'drafts' %}" class="icon-btn" title="Drafts" aria-label="Drafts">
              <!-- folder icon -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 4H2v16h20V6H12l-2-2z" fill="#e5e7eb"/></svg>
            </a>
          </div>
        </div>
      </form>
    </section>
    {% else %}
    <section class="composer-card guest">
      <div style="padding:1rem">
        <p><strong>Welcome!</strong> <a href="{% url 'login' %}">Log in</a> or <a href="{% url 'register' %}">create an account</a> to post and interact.</p>
      </div>
    </section>
    {% endif %}

      <a href="{% url 'profile' post.user.username %}" class="post-avatar-link">
        <div class="avatar post-avatar">
          {{ post.user.username|first|upper }}
        </div>
      </a>

      <div class="post-main">
        <header class="post-header">
          <a href="{% url 'profile' post.user.username %}" class="post-author-link">
            @{{ post.user.username }}
          </a>
          <span class="post-dot">¬∑</span>
          <span class="post-time">{{ post.created_at|timesince }} ago</span>
        </header>

        <p class="post-body">{{ post.content }}</p>

        <!-- Likes -->
        <div class="like-section">
          {% if user.is_authenticated %}
            {% if post.id in liked_posts %}
              <a href="{% url 'unlike' post.id %}" class="action-btn liked-btn">
                ‚ù§Ô∏è {{ post.like_set.count }}
              </a>
            {% else %}
              <a href="{% url 'like' post.id %}" class="action-btn">
                ü§ç {{ post.like_set.count }}
              </a>
            {% endif %}
          {% else %}
            <span class="action-btn disabled">ü§ç {{ post.like_set.count }}</span>
          {% endif %}
              <span class="post-dot">¬∑</span>
              <span class="post-time">{{ post.created_at|timesince }} ago</span>
            </div>
          </header>

          <p class="post-body">{{ post.content }}</p>

          <footer class="post-footer">
            <div class="post-actions">
              <div class="like-section">
                  {% if post.is_community %}
                    <span class="action-btn">
                      <span class="action-icon">ü§ç</span>
                      <span class="action-count">{{ post.like_count }}</span>
                    </span>
                  {% else %}
                    {% if post.id in liked_posts %}
                      <a href="{% url 'unlike' post.id %}" class="action-btn liked">
                        <span class="action-icon">‚ù§Ô∏è</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% else %}
                      <a href="{% url 'like' post.id %}" class="action-btn">
                        <span class="action-icon">ü§ç</span>
                        <span class="action-count">{{ post.like_count }}</span>
                      </a>
                    {% endif %}
                  {% endif %}
              </div>
              <div class="comment-toggle">
                <button type="button" class="action-btn comment-btn" onclick="toggleComments(this)" aria-label="Toggle comments">
                  <span class="action-icon">üí¨</span>
                  <span class="action-count">{{ post.comment_count }}</span>
                  {% if post.comment_count > 0 %}
                    <span class="comment-badge">{{ post.comment_count }}</span>
                  {% endif %}
                </button>
              </div>

              {% if request.user.is_authenticated and request.user == post.user %}
                <div class="post-owner-actions">
                  <a href="{% url 'edit_post' post.id %}" class="action-btn" title="Edit">‚úèÔ∏è</a>
                  <button type="button" class="action-btn delete-btn" data-delete-url="{% url 'delete_post' post.id %}" data-post-content="{{ post.content|escapejs }}" title="Delete">üóëÔ∏è</button>
                </div>
              {% endif %}
              

            </div>
          </footer>

          <!-- COMMENTS -->
          <section class="comments" style="display: none;" aria-label="Comments section">
            <div class="comments-header">
              <h4>
                <span class="comments-icon">üí¨</span>
                Comments
                {% if post.comment_set.count > 0 %}
                  <span class="comments-count">({{ post.comment_set.count }})</span>
                {% endif %}
              </h4>
            </div>
            <div class="comments-list">
              {% for comment in post.comment_set.all %}
                <div class="comment-item">
                  <div class="comment-avatar">{{ comment.user.username|first|upper }}</div>
                  <div class="comment-content">
                    <div class="comment-author">
                      <a href="{% url 'profile' comment.user.username %}">
                        <strong>{{ comment.user.username }}</strong>
                      </a>
                      <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                    </div>
                    <div class="comment-text">{{ comment.text }}</div>
                  </div>
                </div>
              {% empty %}
                <p class="no-comments">
                  <span class="no-comments-icon">üí≠</span>
                  No comments yet. Be the first to comment!
                </p>
              {% endfor %}
            </div>
            <form method="POST" action="{% url 'add_comment' post.id %}" class="comment-form">
              {% csrf_token %}
              <div class="comment-input-wrapper">
                <input type="text" name="comment" placeholder="Write a comment..." required aria-label="Comment input">
                <button type="submit" class="comment-submit-btn" aria-label="Submit comment">
                  <span>Post</span>
                  <span class="submit-icon">‚Üí</span>
                </button>
              </div>
            </form>
          </section>

        </div>

        <!-- Comments -->
       <!-- Comments -->
       <section class="comments-section">

        {% for comment in post.comment_set.all %}
          {% if not comment.parent %}
          <div class="yt-comment">
        
            <!-- Avatar -->
            
            <!-- Comment Body -->
            <div class="yt-body">
        
              <div class="yt-header">
                <span class="yt-username">@{{ comment.user.username }}</span>
                <span class="yt-time">{{ comment.created_at|timesince }} ago</span>
              </div>
        
              <div class="yt-text" id="comment-text-{{ comment.id }}">
                {{ comment.text }}
              </div>
        
              <!-- Actions -->
              <!-- Actions -->
<div class="yt-actions">
  <button onclick="toggleReply('{{ comment.id }}')">Reply</button>

  <a href="{% url 'toggle_comment_like' comment.id %}" class="comment-like-btn">
    {% if comment.id in liked_comments %}
      ‚ù§Ô∏è {{ comment.likes.count }}
    {% else %}
      ü§ç {{ comment.likes.count }}
    {% endif %}
  </a>

  {% if user == comment.user %}
    <button onclick="toggleEdit('{{ comment.id }}')">Edit</button>
    <a href="{% url 'delete_comment' comment.id %}" class="danger">Delete</a>
  {% endif %}
</div>

        
              <!-- Edit form -->
              {% if user == comment.user %}
              <form method="POST"
                    action="{% url 'edit_comment' comment.id %}"
                    id="edit-form-{{ comment.id }}"
                    class="yt-edit-form"
                    style="display:none;">
                {% csrf_token %}
                <input type="text" name="text" value="{{ comment.text }}">
                <button type="submit">Save</button>
              </form>
              {% endif %}
        
              <!-- Reply form -->
              <form method="POST"
                    action="{% url 'reply_comment' comment.id %}"
                    id="reply-form-{{ comment.id }}"
                    class="yt-reply-form"
                    style="display:none;">
                {% csrf_token %}
                <input type="text" name="text" placeholder="Add a reply‚Ä¶">
                <button type="submit">Reply</button>
              </form>
        
              <!-- Replies toggle -->
              {% if comment.replies.count %}
              <button type="button"
              class="yt-view-replies"
              id="toggle-btn-{{ comment.id }}"
              data-count="{{ comment.replies.count }}"
              onclick="toggleReplies('{{ comment.id }}')">
        View {{ comment.replies.count }} replies ‚ñº
      </button>
      
      
              {% endif %}
        
              <!-- Replies -->
              <div class="yt-replies" id="replies-{{ comment.id }}" style="display:none;">
                {% for reply in comment.replies.all %}
                <div class="yt-reply">
        
                  <div class="yt-avatar small">
                    {{ reply.user.username|first|upper }}
                  </div>
        
                  <div class="yt-body">
                    <span class="yt-username">@{{ reply.user.username }}</span>
                    <p>{{ reply.text }}</p>
                  </div>
        
                </div>
                {% endfor %}
              </div>
        
            </div>
          </div>
          {% endif %}
        {% endfor %}
        
        <!-- New Comment -->
        <form method="POST" action="{% url 'add_comment' post.id %}" class="yt-new-comment">
          {% csrf_token %}
          <input type="text" name="comment" placeholder="Add a comment‚Ä¶" required>
          <button type="submit">Send</button>
        </form>
        
        </section>
        


      </div>
    </article>
    {% empty %}
      <p>No posts yet.</p>
    {% endfor %}
  </section>

</main>
</div>


<script>
  function toggleReply(id) {
      const f = document.getElementById(`reply-form-${id}`);
      f.style.display = f.style.display === "block" ? "none" : "block";
  }
  
  function toggleEdit(id) {
      document.getElementById(`edit-form-${id}`).style.display = "block";
      document.getElementById(`comment-text-${id}`).style.display = "none";
  }
  
  function toggleReplies(id) {
      const replies = document.getElementById(`replies-${id}`);
      const btn = document.getElementById(`toggle-btn-${id}`);
  
      if (!replies || !btn) return;
  
      const count = btn.getAttribute("data-count");
  
      if (replies.style.display === "none" || replies.style.display === "") {
          replies.style.display = "block";
          btn.innerText = "Hide replies ‚ñ≤";
      } else {
          replies.style.display = "none";
          btn.innerText = `View ${count} replies ‚ñº`;
      }
  }
  </script>
  

{% endblock %}

 



{% load static %}
<aside class="sidebar">

    <div class="brand">
      <div class="brand-text">
        <h1>vibetext E3</h1>
        <p>Express ‚Ä¢ Engage ‚Ä¢ Echo</p>
      </div>
    </div>

    {% if request.user.is_authenticated %}
    <section class="current-user-card">
      <div class="avatar avatar-lg">
         <img src="{{ profile.photo.url }}{% if profile.photo.name %}?v={{ profile.photo.name }}{% endif %}" alt="{{ request.user.username }}'s avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
      </div>
      <div class="user-meta">
        <h2>@{{ request.user.username }}</h2>
        <p>Logged in user</p>
      </div>

      <a href="{% url 'profile' request.user.username %}" class="btn-link">View Profile</a>
    </section>
    {% else %}
    <section class="current-user-card guest">
      <p>
        <a href="{% url 'login' %}">Login</a> or <a href="{% url 'register' %}">Sign up</a> to post and interact.
      </p>
    </section>
    {% endif %}


    <section class="communities-box">
      <h3 class="communities-title">Communities</h3>
      <p class="communities-desc">Explore communities and join the conversation.</p>
      <p class="communities-link"><a href="{% url 'community_list' %}">Browse communities</a></p>

      {% if request.user.is_authenticated %}
        <div class="communities-create">
          <a class="primary-btn" href="{% url 'create_community' %}">Create community</a>
        </div>
      {% else %}
        <div class="communities-create">
          <a href="{% url 'login' %}">Log in</a> to create a community.
        </div>
      {% endif %}
    </section>

    <section class="people-section">
      <h3>üèÜ Top Creators</h3>

     {% for p in top_creators %}
    <div class="person-row top-creator-row">

      <!-- Avatar -->
      <div class="avatar">
        {{ p.user.username|first|upper }}
      </div>

      <!-- Username + level + follow -->
      <div class="person-main-inline">

        <div class="username-line">
          <a href="{% url 'profile' p.user.username %}" class="username-link">
            {{ p.user.username }}
          </a>

          {% if forloop.first %}
            <span class="rank-icon">üëë</span>
          {% else %}
            <span class="rank-number">#{{ forloop.counter }}</span>
          {% endif %}

          <span class="level-badge level-{{ p.level|slugify }}">
            {{  p.level }}
          </span>

        </div>

        {% if request.user != p.user %}
          {% if p.user.id in following_ids %}
            <form method="POST"
                  action="{% url 'unfollow_user' p.user.id %}"
                  class="ajax-follow inline-form">
              {% csrf_token %}
              <button type="submit" class="follow-chip small">Unfollow</button>
            </form>
          {% else %}
            <form method="POST"
                  action="{% url 'follow_user' p.user.id %}"
                  class="ajax-follow inline-form">
              {% csrf_token %}
              <button type="submit" class="follow-chip small">Follow</button>
            </form>
          {% endif %}
        {% endif %}

      </div>
    </div>

  {% empty %}
    <p>No creators yet</p>

  {% endfor %}

    </section>

</aside>

<script>
(function() {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('submit', function(e) {
    const form = e.target;
    if (!form.classList.contains('ajax-follow')) return;
    e.preventDefault();

    const url = form.action;
    const csrftoken = getCookie('csrftoken');

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams(new FormData(form))
    }).then(r => r.json()).then(json => {
      if (json.status !== 'ok') {
        alert(json.message || 'Something went wrong');
        return;
      }

      // Update UI: swap Follow <-> Following where possible
      const btn = form.querySelector('button[type="submit"]');
      if (!btn) return;
      if (json.created || json.is_following) {
        btn.textContent = 'Following';
        btn.classList.add('following');
      } else if (json.deleted === true) {
        btn.textContent = 'Follow';
        btn.classList.remove('following');
      } else if (json.created === false) {
        btn.textContent = 'Following';
        btn.classList.add('following');
      }
      // Optionally update follower counts if returned
      if (typeof json.followers_count !== 'undefined') {
        // attempt to find a matching followers stat for this user and update it
        const userId = url.split('/').filter(Boolean).pop();
        const followersEls = document.querySelectorAll('.profile-stats .stat-item');
        // best-effort update: if profile page, replace .stat-number inside for followers
        const followerNumber = document.querySelector('.profile-stats [href*="/followers/"] .stat-number');
        if (followerNumber) followerNumber.textContent = json.followers_count;
      }
    }).catch(() => {
      alert('Network error');
    });
  });
})();
</script>


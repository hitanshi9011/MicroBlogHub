{% load static %}
<aside class="sidebar">

    <div class="brand">
      <div class="brand-text">
        <h1>vibetext E3</h1>
        <p>Express ‚Ä¢ Engage ‚Ä¢ Echo</p>
      </div>
    </div>

    {% if request.user.is_authenticated %}
    <section class="current-user-card">
      <div class="avatar avatar-lg">
         <img src="{{ profile.photo.url }}{% if profile.photo.name %}?v={{ profile.photo.name }}{% endif %}" alt="{{ request.user.username }}'s avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
      </div>
      <div class="user-meta">
        <h2>@{{ request.user.username }}</h2>
        <p>Logged in user</p>
      </div>

      <a href="{% url 'profile' request.user.username %}" class="btn-link">View Profile</a>
      <a href="{% url 'bookmarks' %}" class="btn-link">Bookmarks</a>
    </section>
    {% else %}
    <section class="current-user-card guest">
      <p>
        <a href="{% url 'login' %}">Login</a> or <a href="{% url 'register' %}">Sign up</a> to post and interact.
      </p>
    </section>
    {% endif %}


    <section class="communities-box">
      <h3 class="communities-title">Communities</h3>
      <p class="communities-desc">Explore communities and join the conversation.</p>
      <p class="communities-link"><a href="{% url 'community_list' %}">Browse communities</a></p>

      {% if request.user.is_authenticated %}
        <div class="communities-create">
          <a class="primary-btn" href="{% url 'create_community' %}">Create community</a>
        </div>
      {% else %}
        <div class="communities-create">
          <a href="{% url 'login' %}">Log in</a> to create a community.
        </div>
      {% endif %}
    </section>

    <section class="people-section">
      <h3>üèÜ Top Creators</h3>

      {% for p in top_creators %}
      <div class="creator-row">
        <a class="creator-link" href="{% url 'profile' p.user.username %}" title="@{{ p.user.username }}">
          <div class="creator-avatar">
            <img src="{{ p.photo_url }}" alt="{{ p.user.username }}" onerror="this.src='{% static 'images/default_avatar.svg' %}'" />
          </div>
          <div class="creator-meta">
            <div class="creator-top">
              <strong class="creator-username">@{{ p.user.username }}</strong>
              <span class="creator-badge" title="{{ p.badge_name }}">{{ p.badge_icon }} {{ p.badge_name }}</span>
            </div>
            
            {% if request.user.is_authenticated and request.user != p.user %}
              <div class="creator-actions">
                {% if following_ids and p.user.id in following_ids %}
                  <form class="ajax-follow" method="POST" action="{% url 'unfollow' p.user.id %}" data-follow-url="{% url 'follow' p.user.id %}" data-unfollow-url="{% url 'unfollow' p.user.id %}">
                    {% csrf_token %}
                    <button type="submit" class="follow-btn following">Following</button>
                  </form>
                {% else %}
                  <form class="ajax-follow" method="POST" action="{% url 'follow' p.user.id %}" data-follow-url="{% url 'follow' p.user.id %}" data-unfollow-url="{% url 'unfollow' p.user.id %}">
                    {% csrf_token %}
                    <button type="submit" class="follow-btn">Follow</button>
                  </form>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </a>
      </div>
      {% empty %}
      <div class="creator-empty">No creators yet ‚Äî be the first to post quality content!</div>
      {% endfor %}
    </section>

</aside>

<script>
(function() {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('submit', function(e) {
    const form = e.target;
    if (!form.classList.contains('ajax-follow')) return;
    e.preventDefault();

    const url = form.action;
    const csrftoken = getCookie('csrftoken');

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams(new FormData(form))
    }).then(r => r.json()).then(json => {
      if (json.status !== 'ok') {
        alert(json.message || 'Something went wrong');
        return;
      }

      // Update UI: swap Follow <-> Following where possible and update form action so next submit toggles
      const btn = form.querySelector('button[type="submit"]');
      if (!btn) return;
      const followUrl = form.getAttribute('data-follow-url');
      const unfollowUrl = form.getAttribute('data-unfollow-url');

      if (json.created || json.is_following) {
        // now following
        btn.textContent = 'Following';
        btn.classList.add('following');
        if (unfollowUrl) form.action = unfollowUrl;
      } else if (json.deleted === true) {
        // now unfollowed
        btn.textContent = 'Follow';
        btn.classList.remove('following');
        if (followUrl) form.action = followUrl;
      } else if (json.created === false) {
        btn.textContent = 'Following';
        btn.classList.add('following');
        if (unfollowUrl) form.action = unfollowUrl;
      }
      // Optionally update follower counts if returned
      if (typeof json.followers_count !== 'undefined') {
        // attempt to find a matching followers stat for this user and update it
        const userId = url.split('/').filter(Boolean).pop();
        const followersEls = document.querySelectorAll('.profile-stats .stat-item');
        // best-effort update: if profile page, replace .stat-number inside for followers
        const followerNumber = document.querySelector('.profile-stats [href*="/followers/"] .stat-number');
        if (followerNumber) followerNumber.textContent = json.followers_count;
      }
    }).catch(() => {
      alert('Network error');
    });
  });
})();
</script>

